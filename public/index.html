<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trakt Sync & Rate - Stremio Addon Configurator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: #94a3b8;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .section {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .section:hover {
            transform: translateY(-2px);
        }

        .section-title {
            font-size: 1.4rem;
            color: #60a5fa;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title svg {
            width: 24px;
            height: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #60a5fa;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        /* Rating Style Selection */
        .rating-style-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .rating-style-option {
            flex: 1;
            min-width: 200px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-style-option:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }

        .rating-style-option.selected {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .style-preview {
            font-size: 24px;
            margin-bottom: 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .style-label {
            font-weight: 600;
            color: #cbd5e1;
        }

        /* Rating Presets */
        .rating-presets {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .rating-preset {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-preset:hover {
            border-color: rgba(96, 165, 250, 0.5);
        }

        .rating-preset.selected {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .rating-preset .stars {
            font-size: 18px;
            margin-bottom: 8px;
            color: #fbbf24;
        }

        .rating-preset .value {
            font-weight: 600;
            color: #cbd5e1;
        }

        /* Pattern Options - COMPACT VERSION */
        .pattern-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pattern-option {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pattern-option:hover {
            border-color: rgba(96, 165, 250, 0.5);
        }

        .pattern-option.selected {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .pattern-option input[type="radio"] {
            margin-right: 10px;
            accent-color: #60a5fa;
        }

        .pattern-preview-container {
            margin-top: 15px;
            padding: 15px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pattern-preview-title {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 10px;
        }

        .pattern-preview {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-height: 200px;
            overflow-y: auto;
        }

        /* Stats Format Options */
        .stats-format-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stats-format-option {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stats-format-option:hover {
            border-color: rgba(96, 165, 250, 0.5);
        }

        .stats-format-option.selected {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .stats-format-option input[type="radio"] {
            margin-right: 10px;
            accent-color: #60a5fa;
        }

        /* Stats Selection */
        .stats-selection {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-select {
            flex: 1;
            min-width: 200px;
        }

        .selected-stats-display {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }

        /* Preview Section */
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .preview-grid {
                grid-template-columns: 1fr;
            }
        }

        .preview-category {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            padding: 15px;
        }

        .preview-category-title {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stream-count {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .preview-content {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #60a5fa;
        }

        .preview-item.watched {
            border-left-color: #10b981;
        }

        .preview-item.unwatched {
            border-left-color: #ef4444;
        }

        .preview-item.season {
            border-left-color: #8b5cf6;
        }

        .preview-item.rating {
            border-left-color: #f59e0b;
        }

        .preview-item.watchlist {
            border-left-color: #3b82f6;
        }

        .preview-item.watchlist-remove {
            border-left-color: #ef4444;
        }

        /* Auth Popup */
        .auth-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .auth-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .auth-title {
            color: #60a5fa;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .auth-steps {
            margin: 20px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
        }

        .auth-step {
            margin-bottom: 15px;
            padding-left: 25px;
            position: relative;
        }

        .auth-step:before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            width: 16px;
            height: 16px;
            background: #60a5fa;
            border-radius: 50%;
        }

        .auth-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
        }

        .status {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .status-success {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-warning {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Result Section */
        .result-section {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .addon-url {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            word-break: break-all;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Slider Styles */
        .slider-container {
            margin: 20px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slider-value {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #60a5fa;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #3b82f6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .rating-style-options,
            .stats-selection {
                flex-direction: column;
            }
            
            .rating-style-option,
            .stat-select {
                min-width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: normal;
            line-height: 1.4;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Stats Examples */
        .stats-examples {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-example {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: monospace;
            color: #94a3b8;
        }

        /* Compact pattern labels */
        .pattern-label {
            font-weight: 600;
            color: #cbd5e1;
        }

        .pattern-description {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ Trakt Sync & Rate</h1>
            <p class="tagline">Create your personalized Stremio addon to sync watched states, rate content, and manage watchlist on Trakt.tv</p>
        </header>

        <!-- Authentication Section -->
        <section class="section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                    <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Authentication
            </h2>
            
            <div class="form-group">
                <label for="clientId">Trakt Client ID
                    <span class="tooltip">
                        ‚ìò
                        <span class="tooltiptext">
                            Get your Trakt Client ID from:<br>
                            1. Go to https://trakt.tv/oauth/applications<br>
                            2. Click "New Application"<br>
                            3. Name it "Stremio Trakt Addon"<br>
                            4. Set Redirect URI to: urn:ietf:wg:oauth:2.0:oob<br>
                            5. Copy the Client ID
                        </span>
                    </span>
                </label>
                <input type="text" id="clientId" placeholder="Enter your Trakt Client ID">
            </div>
            
            <div class="form-group">
                <label for="tmdbKey">TMDB API Key (Optional)
                    <span class="tooltip">
                        ‚ìò
                        <span class="tooltiptext">
                            Get from https://www.themoviedb.org/settings/api<br>
                            Used to fetch movie/show titles for better display<br>
                            Not required for basic functionality
                        </span>
                    </span>
                </label>
                <input type="password" id="tmdbKey" placeholder="Enter TMDB API Key (optional)">
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="startAuth()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                        <polyline points="10 17 15 12 10 7"/>
                        <line x1="15" y1="12" x2="3" y2="12"/>
                    </svg>
                    Connect to Trakt
                </button>
            </div>
            
            <div id="mainAuthStatus" class="status status-warning">Not connected to Trakt</div>
        </section>

        <!-- Addon Settings Section -->
        <section class="section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/>
                </svg>
                Addon Settings
            </h2>
            
            <div class="form-group">
                <label for="addonName">Addon Display Name</label>
                <div id="addonNamePreview" style="background: rgba(15, 23, 42, 0.8); border-radius: 10px; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                    Trakt Sync & Rate
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="showUsername" checked>
                <label for="showUsername">Show username in addon name</label>
            </div>
        </section>

        <!-- Features Section -->
        <section class="section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 12 20 22 4 22 4 12"/>
                    <rect x="2" y="7" width="20" height="5"/>
                    <line x1="12" y1="22" x2="12" y2="7"/>
                    <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/>
                    <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/>
                </svg>
                Features to Enable
            </h2>
            
            <div class="checkbox-group">
                <input type="checkbox" id="enableWatched" checked>
                <label for="enableWatched">Mark as Watched</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="enableUnwatched" checked>
                <label for="enableUnwatched">Mark as Unwatched</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="enableSeasonWatched" checked>
                <label for="enableSeasonWatched">Mark Entire Season as Watched (Series)</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="enableWatchlist" checked>
                <label for="enableWatchlist">Add to Watchlist</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="enableRemoveFromWatchlist" checked>
                <label for="enableRemoveFromWatchlist">Remove from Watchlist</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="enableRatings" checked>
                <label for="enableRatings">Enable Ratings</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="markAsPlayedOnRate">
                <label for="markAsPlayedOnRate">Automatically mark as played when rating</label>
            </div>
        </section>

        <!-- Ratings Section -->
        <section id="ratingSection" class="section" style="display: block;">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
                Ratings Configuration
            </h2>
            
            <div class="form-group">
                <label>Select Rating Values to Show
                    <span id="selectedCount" class="slider-value" style="margin-left: 10px;">3/10</span>
                </label>
                
                <div class="rating-presets" id="ratingPresets">
                    <!-- Rating presets will be generated here -->
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-small btn-secondary" onclick="selectAllRatings()">Select All</button>
                    <button class="btn btn-small btn-secondary" onclick="clearAllRatings()">Clear All</button>
                    <button class="btn btn-small btn-secondary" onclick="selectDefaultRatings()">Default (5, 7, 10)</button>
                </div>
            </div>
            
            <!-- Rating Style Selection -->
            <div class="form-group">
                <label>Rating Visual Style
                    <span class="tooltip">
                        ‚ìò
                        <span class="tooltiptext">
                            Choose how ratings will be displayed in Stremio:<br>
                            ‚Ä¢ Stars: ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ<br>
                            ‚Ä¢ Hearts: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏èü§çü§çü§çü§çü§çü§çü§ç<br>
                            ‚Ä¢ Progress: ‚ñ∞‚ñ∞‚ñ∞‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±
                        </span>
                    </span>
                </label>
                
                <div class="rating-style-options">
                    <div class="rating-style-option selected" id="style-stars" onclick="selectRatingStyle('stars')">
                        <div class="style-preview" id="starsVisual">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
                        <div class="style-label">Stars</div>
                    </div>
                    <div class="rating-style-option" id="style-hearts" onclick="selectRatingStyle('hearts')">
                        <div class="style-preview" id="heartsVisual">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏èü§çü§çü§çü§çü§ç</div>
                        <div class="style-label">Hearts</div>
                    </div>
                    <div class="rating-style-option" id="style-progress" onclick="selectRatingStyle('progress')">
                        <div class="style-preview" id="progressVisual">‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±</div>
                        <div class="style-label">Progress</div>
                    </div>
                </div>
            </div>
            
            <!-- Rating Pattern Selection - COMPACT VERSION -->
            <div class="form-group">
                <label>Rating Display Pattern</label>
                
                <div class="pattern-options">
                    <div class="pattern-option selected" id="pattern-option-0" onclick="selectRatingPattern(0)">
                        <div style="display: flex; align-items: center;">
                            <input type="radio" name="ratingPattern" id="pattern0" checked>
                            <div>
                                <div class="pattern-label">Simple Rating</div>
                                <div class="pattern-description">Basic rating with visual stars</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pattern-option" id="pattern-option-1" onclick="selectRatingPattern(1)">
                        <div style="display: flex; align-items: center;">
                            <input type="radio" name="ratingPattern" id="pattern1">
                            <div>
                                <div class="pattern-label">Emoji-First Vertical</div>
                                <div class="pattern-description">Detailed rating with stats in vertical format</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pattern-option" id="pattern-option-6" onclick="selectRatingPattern(6)">
                        <div style="display: flex; align-items: center;">
                            <input type="radio" name="ratingPattern" id="pattern6">
                            <div>
                                <div class="pattern-label">Cinematic Rating Card</div>
                                <div class="pattern-description">Professional rating card with media type</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pattern-preview-container">
                    <div class="pattern-preview-title">Preview:</div>
                    <div class="pattern-preview" id="currentPatternPreview">
                        ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ
                        "The Matrix" 5/10
                    </div>
                </div>
            </div>
            
            <!-- Stats Format Selection -->
            <div class="form-group">
                <label>Stats Display Format</label>
                
                <div class="stats-format-options">
                    <div class="stats-format-option selected" id="stats-option-1" onclick="selectStatsFormat(1)">
                        <input type="radio" name="statsFormat" id="stats1" checked>
                        <label for="stats1" style="display: inline;">Format 1: Compact Stats (üëÅÔ∏è 3.1k watchers - ‚ñ∂Ô∏è 5.8k plays)</label>
                    </div>
                    
                    <div class="stats-format-option" id="stats-option-2" onclick="selectStatsFormat(2)">
                        <input type="radio" name="statsFormat" id="stats2">
                        <label for="stats2" style="display: inline;">Format 2: Detailed Stats (üëÅÔ∏è watchers: 3.1k | ‚ñ∂Ô∏è plays: 5.8k)</label>
                    </div>
                    
                    <div class="stats-format-option" id="stats-option-3" onclick="selectStatsFormat(3)">
                        <input type="radio" name="statsFormat" id="stats3">
                        <label for="stats3" style="display: inline;">Format 3: Minimal Stats (üëÅÔ∏è 3.1k | ‚ñ∂Ô∏è 5.8k)</label>
                    </div>
                    
                    <div class="stats-format-option" id="stats-option-4" onclick="selectStatsFormat(4)">
                        <input type="radio" name="statsFormat" id="stats4">
                        <label for="stats4" style="display: inline;">Format 4: Vertical Stats (multi-line)</label>
                    </div>
                    
                    <div class="stats-format-option" id="stats-option-5" onclick="selectStatsFormat(5)">
                        <input type="radio" name="statsFormat" id="stats5">
                        <label for="stats5" style="display: inline;">Format 5: Balanced Stats (üëÅÔ∏è 3.1k watching | ‚ñ∂Ô∏è 5.8k played)</label>
                    </div>
                </div>
            </div>
            
            <!-- Stats Selection -->
            <div class="form-group">
                <label>Select Trakt Stats to Display
                    <span class="tooltip">
                        ‚ìò
                        <span class="tooltiptext">
                            Choose up to 3 stats from Trakt to display with ratings.<br>
                            These will be shown in the rating stream titles.
                        </span>
                    </span>
                </label>
                
                <div class="stats-selection">
                    <div class="stat-select">
                        <label for="stat1">Stat 1</label>
                        <select id="stat1Select">
                            <option value="watchers">üëÅÔ∏è Watchers</option>
                            <option value="plays" selected>‚ñ∂Ô∏è Plays</option>
                            <option value="comments">üí¨ Comments</option>
                            <option value="lists">üìã Lists</option>
                            <option value="collectors">‚≠ê Collectors</option>
                            <option value="votes">üëç Votes</option>
                        </select>
                    </div>
                    
                    <div class="stat-select">
                        <label for="stat2">Stat 2</label>
                        <select id="stat2Select">
                            <option value="watchers">üëÅÔ∏è Watchers</option>
                            <option value="plays">‚ñ∂Ô∏è Plays</option>
                            <option value="comments" selected>üí¨ Comments</option>
                            <option value="lists">üìã Lists</option>
                            <option value="collectors">‚≠ê Collectors</option>
                            <option value="votes">üëç Votes</option>
                        </select>
                    </div>
                    
                    <div class="stat-select">
                        <label for="stat3">Stat 3</label>
                        <select id="stat3Select">
                            <option value="watchers" selected>üëÅÔ∏è Watchers</option>
                            <option value="plays">‚ñ∂Ô∏è Plays</option>
                            <option value="comments">üí¨ Comments</option>
                            <option value="lists">üìã Lists</option>
                            <option value="collectors">‚≠ê Collectors</option>
                            <option value="votes">üëç Votes</option>
                        </select>
                    </div>
                </div>
                
                <div class="selected-stats-display">
                    Selected Stats: <span id="selectedStatsDisplay">üëÅÔ∏è Watchers, ‚ñ∂Ô∏è Plays, üí¨ Comments</span>
                </div>
            </div>
            
            <!-- Preview Slider -->
            <div class="form-group">
                <label>Preview with different rating values</label>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Adjust preview rating:</span>
                        <span class="slider-value" id="sliderValue">5</span>
                    </div>
                    <input type="range" id="ratingSlider" min="1" max="10" value="5" step="1">
                </div>
            </div>
        </section>

        <!-- Preview Section -->
        <section class="section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/>
                    <line x1="7" y1="2" x2="7" y2="22"/>
                    <line x1="17" y1="2" x2="17" y2="22"/>
                    <line x1="2" y1="12" x2="22" y2="12"/>
                    <line x1="2" y1="7" x2="7" y2="7"/>
                    <line x1="2" y1="17" x2="7" y2="17"/>
                    <line x1="17" y1="17" x2="22" y2="17"/>
                    <line x1="17" y1="7" x2="22" y2="7"/>
                </svg>
                Addon Preview
            </h2>
            
            <div class="preview-grid">
                <!-- Movie Preview -->
                <div class="preview-category">
                    <div class="preview-category-title">
                        <span>Movie Options</span>
                        <span class="stream-count" id="movieStreamCount">0</span>
                    </div>
                    <div class="preview-content" id="movieWatchedContent">
                        <!-- Watched options will appear here -->
                    </div>
                    <div class="preview-content" id="movieUnwatchedContent">
                        <!-- Unwatched options will appear here -->
                    </div>
                    <div class="preview-content" id="movieWatchlistContent">
                        <!-- Watchlist options will appear here -->
                    </div>
                    <div class="preview-content" id="movieRatingsContent">
                        <!-- Rating options will appear here -->
                    </div>
                </div>
                
                <!-- Series Preview -->
                <div class="preview-category">
                    <div class="preview-category-title">
                        <span>Series Options</span>
                        <span class="stream-count" id="seriesStreamCount">0</span>
                    </div>
                    <div class="preview-content" id="seriesWatchedContent">
                        <!-- Watched options will appear here -->
                    </div>
                    <div class="preview-content" id="seriesWatchlistContent">
                        <!-- Watchlist options will appear here -->
                    </div>
                    <div class="preview-content" id="seriesRatingsContent">
                        <!-- Rating options will appear here -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Generate Addon Section -->
        <section class="section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                Generate Your Addon
            </h2>
            
            <p style="margin-bottom: 20px; color: #94a3b8;">
                Make sure you're connected to Trakt and all settings are configured before generating your addon.
            </p>
            
            <div class="btn-group">
                <button class="btn" onclick="generateAddonUrl()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6"/>
                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                        <path d="M3 22v-6h6"/>
                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                    </svg>
                    Generate Addon URL
                </button>
            </div>
        </section>

        <!-- Result Section -->
        <div id="resultSection" class="result-section">
            <h2 class="section-title" style="color: #10b981;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Your Addon is Ready!
            </h2>
            
            <p style="margin-bottom: 15px; color: #94a3b8;">
                Copy the URL below and add it to Stremio as a Community Addon:
            </p>
            
            <div class="addon-url" id="addonUrlDiv">
                <!-- Addon URL will appear here -->
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="installInStremioDesktop()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    Install in Stremio Desktop
                </button>
                <button class="btn btn-secondary" onclick="installInStremioWeb()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="4"/>
                        <line x1="21.17" y1="8" x2="12" y2="8"/>
                        <line x1="3.95" y1="6.06" x2="8.54" y2="14"/>
                        <line x1="10.88" y1="21.94" x2="15.46" y2="14"/>
                    </svg>
                    Install in Stremio Web
                </button>
                <button class="btn btn-secondary" onclick="copyToClipboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Copy URL
                </button>
                <button class="btn btn-secondary" onclick="testAddon()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                    </svg>
                    Test Addon
                </button>
                <button class="btn btn-secondary" onclick="resetConfig()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2.5 2v6h6M2.66 15.57a10 10 0 1 0 .57-8.38"/>
                    </svg>
                    Reset Configuration
                </button>
            </div>
        </div>

        <!-- Footer -->
        <footer style="text-align: center; margin-top: 40px; padding: 20px; color: #64748b; font-size: 0.9rem;">
            <p>Trakt Sync & Rate - A Stremio Community Addon</p>
            <p style="margin-top: 10px;">
                Need help? Check the 
                <a href="https://github.com/ericvlog/trakt-sync-rating-addon" style="color: #60a5fa; text-decoration: none;" target="_blank">
                    GitHub Repository
                </a>
            </p>
        </footer>
    </div>

    <!-- Auth Popup -->
    <div id="authPopup" class="auth-popup">
        <div class="auth-content">
            <h2 class="auth-title">Connect to Trakt.tv</h2>
            
            <div class="auth-steps">
                <div class="auth-step">Click "Open Trakt.tv" button below</div>
                <div class="auth-step">Log in to your Trakt account (if not already)</div>
                <div class="auth-step">Authorize the application</div>
                <div class="auth-step">Copy the authorization code from the page</div>
                <div class="auth-step">Paste the code below and submit</div>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="openTraktAuth()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                    Open Trakt.tv
                </button>
                <button class="btn btn-secondary" onclick="closeAuthPopup()">Cancel</button>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="authCode">Authorization Code</label>
                <input type="text" id="authCode" placeholder="Paste the authorization code here">
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="submitAuthCode()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13"/>
                        <path d="M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    Submit Code
                </button>
            </div>
            
            <div id="popupAuthStatus" class="auth-status status">
                Waiting for authorization...
            </div>
        </div>
    </div>

    <script>
        // State variables
        let traktTokens = null;
        let currentUsername = 'TraktUser';
        let selectedRatings = [5, 7, 10];
        let selectedRatingStyle = 'stars';
        let selectedRatingPattern = 0;
        let selectedStatsFormat = 1;
        let selectedStats = ['plays', 'comments', 'watchers'];
        let previewRatingValue = 5;
        let markAsPlayedOnRate = false;
        let enableWatchlist = true;
        let enableRemoveFromWatchlist = true;

        // DOM Elements
        const clientIdInput = document.getElementById('clientId');
        const tmdbKeyInput = document.getElementById('tmdbKey');
        const showUsernameCheckbox = document.getElementById('showUsername');
        const enableWatchedCheckbox = document.getElementById('enableWatched');
        const enableUnwatchedCheckbox = document.getElementById('enableUnwatched');
        const enableSeasonWatchedCheckbox = document.getElementById('enableSeasonWatched');
        const enableWatchlistCheckbox = document.getElementById('enableWatchlist');
        const enableRemoveFromWatchlistCheckbox = document.getElementById('enableRemoveFromWatchlist');
        const enableRatingsCheckbox = document.getElementById('enableRatings');
        const markAsPlayedOnRateCheckbox = document.getElementById('markAsPlayedOnRate');
        const ratingSection = document.getElementById('ratingSection');
        const ratingPresetsDiv = document.getElementById('ratingPresets');
        const selectedCountSpan = document.getElementById('selectedCount');
        const starsVisual = document.getElementById('starsVisual');
        const heartsVisual = document.getElementById('heartsVisual');
        const progressVisual = document.getElementById('progressVisual');
        const currentPatternPreview = document.getElementById('currentPatternPreview');
        const selectedStatsDisplay = document.getElementById('selectedStatsDisplay');
        const addonNamePreview = document.getElementById('addonNamePreview');
        const ratingSlider = document.getElementById('ratingSlider');
        const sliderValue = document.getElementById('sliderValue');
        const stat1Select = document.getElementById('stat1Select');
        const stat2Select = document.getElementById('stat2Select');
        const stat3Select = document.getElementById('stat3Select');

        // Preview elements
        const movieWatchedContent = document.getElementById('movieWatchedContent');
        const movieUnwatchedContent = document.getElementById('movieUnwatchedContent');
        const movieWatchlistContent = document.getElementById('movieWatchlistContent');
        const movieRatingsContent = document.getElementById('movieRatingsContent');
        const movieStreamCount = document.getElementById('movieStreamCount');
        const seriesWatchedContent = document.getElementById('seriesWatchedContent');
        const seriesWatchlistContent = document.getElementById('seriesWatchlistContent');
        const seriesRatingsContent = document.getElementById('seriesRatingsContent');
        const seriesStreamCount = document.getElementById('seriesStreamCount');

        // Auth elements
        const authPopup = document.getElementById('authPopup');
        const authCodeInput = document.getElementById('authCode');
        const mainAuthStatus = document.getElementById('mainAuthStatus');
        const popupAuthStatus = document.getElementById('popupAuthStatus');

        // Result elements
        const resultSection = document.getElementById('resultSection');
        const addonUrlDiv = document.getElementById('addonUrlDiv');

        // Trakt stats info
        const traktStatsInfo = {
            'watchers': { emoji: 'üëÅÔ∏è', name: 'watchers' },
            'plays': { emoji: '‚ñ∂Ô∏è', name: 'plays' },
            'comments': { emoji: 'üí¨', name: 'comments' },
            'lists': { emoji: 'üìã', name: 'lists' },
            'collectors': { emoji: '‚≠ê', name: 'collectors' },
            'votes': { emoji: 'üëç', name: 'votes' }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Set up event listeners
            showUsernameCheckbox.addEventListener('change', updateAddonNamePreview);
            enableRatingsCheckbox.addEventListener('change', function() {
                ratingSection.style.display = this.checked ? 'block' : 'none';
                updatePreview();
                saveData();
            });
            
            enableWatchedCheckbox.addEventListener('change', updatePreviewAndSave);
            enableUnwatchedCheckbox.addEventListener('change', updatePreviewAndSave);
            enableSeasonWatchedCheckbox.addEventListener('change', updatePreviewAndSave);
            enableWatchlistCheckbox.addEventListener('change', function() {
                enableWatchlist = this.checked;
                updatePreview();
                saveData();
            });
            enableRemoveFromWatchlistCheckbox.addEventListener('change', function() {
                enableRemoveFromWatchlist = this.checked;
                updatePreview();
                saveData();
            });
            markAsPlayedOnRateCheckbox.addEventListener('change', function() {
                markAsPlayedOnRate = this.checked;
                saveData();
            });
            
            // Rating slider
            ratingSlider.addEventListener('input', function() {
                previewRatingValue = parseInt(this.value);
                sliderValue.textContent = previewRatingValue;
                updateRatingStyleVisuals();
                updatePatternPreview();
                updatePreview();
                saveData();
            });

            // Stats selection
            stat1Select.addEventListener('change', updateStats);
            stat2Select.addEventListener('change', updateStats);
            stat3Select.addEventListener('change', updateStats);

            // Initialize components
            generateRatingPresets();
            updateSelectedCount();
            updateRatingStyleVisuals();
            updatePatternPreview();
            updateSelectedStatsDisplay();
            updateAddonNamePreview();
            updatePreview();

            // Load saved data
            loadSavedData();
        }

        function updatePreviewAndSave() {
            updatePreview();
            saveData();
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            }
            return num.toString();
        }

        function updateStats() {
            selectedStats = [
                stat1Select.value,
                stat2Select.value,
                stat3Select.value
            ];
            updateSelectedStatsDisplay();
            updatePatternPreview();
            updatePreview();
            saveData();
        }

        function updateSelectedStatsDisplay() {
            const statNames = selectedStats.map(stat => {
                const info = traktStatsInfo[stat] || { emoji: 'üìä', name: stat };
                return `${info.emoji} ${info.name.charAt(0).toUpperCase() + info.name.slice(1)}`;
            });
            selectedStatsDisplay.textContent = statNames.join(', ');
        }

        function selectStatsFormat(format) {
            selectedStatsFormat = format;
            document.querySelectorAll('.stats-format-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('input[type="radio"]').checked = false;
            });
            const selectedOption = document.getElementById(`stats-option-${format}`);
            selectedOption.classList.add('selected');
            selectedOption.querySelector('input[type="radio"]').checked = true;
            updatePatternPreview();
            updatePreview();
            saveData();
        }

        function selectRatingPattern(pattern) {
            selectedRatingPattern = pattern;
            document.querySelectorAll('.pattern-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('input[type="radio"]').checked = false;
            });
            const selectedOption = document.getElementById(`pattern-option-${pattern}`);
            selectedOption.classList.add('selected');
            selectedOption.querySelector('input[type="radio"]').checked = true;
            updatePatternPreview();
            updatePreview();
            saveData();
        }

        function updatePatternPreview() {
            const visual = generateRatingVisual(selectedRatingStyle, previewRatingValue);
            const statsLine = getStatsLinePreview(previewRatingValue);
            
            let previewText = '';
            
            switch(selectedRatingPattern) {
                case 0:
                    previewText = `${visual}\n"The Matrix" ${previewRatingValue}/10`;
                    break;
                case 1:
                    previewText = `‚≠ê Rating: ${previewRatingValue}/10\nüé¨ The Matrix (Movie)\n${visual}\n${statsLine}\nüìä ${previewRatingValue} out of 10 stars`;
                    break;
                case 6:
                    previewText = `üé¨ The Matrix (1999)\n‚≠ê ${visual}\nüéØ Rating ${previewRatingValue}/10\n${statsLine}\nüìä ${previewRatingValue} out of 10 stars`;
                    break;
                default:
                    previewText = `${visual}\n"The Matrix" ${previewRatingValue}/10`;
            }
            
            currentPatternPreview.textContent = previewText;
        }

        function getStatsLinePreview(rating) {
            const exampleValues = {
                'watchers': Math.round((rating * 125) + 50),
                'plays': Math.round((rating * 510) + 1000),
                'comments': Math.round(rating * 2.4),
                'lists': Math.round(rating * 5),
                'collectors': Math.round(rating * 9),
                'votes': Math.round(rating * 36)
            };

            const statValues = selectedStats.map(stat => exampleValues[stat] || 0);
            const formattedStats = selectedStats.map((stat, index) => {
                const value = statValues[index];
                const formattedValue = formatNumber(value);
                const info = traktStatsInfo[stat] || { emoji: 'üìä', name: stat };
                const displayName = getStatDisplayName(stat, value);
                return {
                    emoji: info.emoji,
                    value: formattedValue,
                    name: displayName
                };
            });

            switch(selectedStatsFormat) {
                case 1: return formattedStats.map(s => `${s.emoji} ${s.value} ${s.name}`).join(' - ');
                case 2: return formattedStats.map(s => `${s.emoji} ${s.name}: ${s.value}`).join(' | ');
                case 3: return formattedStats.map(s => `${s.emoji} ${s.value}`).join(' | ');
                case 4: return formattedStats.map(s => `${s.emoji} ${s.value} ${s.name}`).join('\n');
                case 5:
                    const customNames = {
                        'watchers': 'watching',
                        'plays': 'played',
                        'comments': 'commented',
                        'lists': 'listed',
                        'collectors': 'collected',
                        'votes': 'voted'
                    };
                    return formattedStats.map(s => {
                        const customName = customNames[s.name] || s.name;
                        return `${s.emoji} ${s.value} ${customName}`;
                    }).join(' | ');
                default: return formattedStats.map(s => `${s.emoji} ${s.value} ${s.name}`).join(' - ');
            }
        }

        function getStatDisplayName(stat, value) {
            const displayMap = {
                'watchers': value === 1 ? 'watcher' : 'watchers',
                'plays': value === 1 ? 'play' : 'plays',
                'comments': value === 1 ? 'comment' : 'comments',
                'lists': value === 1 ? 'list' : 'lists',
                'collectors': value === 1 ? 'collector' : 'collectors',
                'votes': value === 1 ? 'vote' : 'votes'
            };
            return displayMap[stat] || stat;
        }

        function selectRatingStyle(style) {
            selectedRatingStyle = style;
            // Remove 'selected' class from all style options
            document.querySelectorAll('.rating-style-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add 'selected' class to the clicked one
            document.getElementById(`style-${style}`).classList.add('selected');
            updateRatingStyleVisuals();
            updatePatternPreview();
            updatePreview();
            saveData();
        }

        function updateRatingStyleVisuals() {
            let stars = '';
            for (let i = 1; i <= 10; i++) {
                stars += i <= previewRatingValue ? '‚òÖ' : '‚òÜ';
            }
            starsVisual.textContent = stars;

            let hearts = '';
            for (let i = 1; i <= 10; i++) {
                hearts += i <= previewRatingValue ? '‚ù§Ô∏è' : 'ü§ç';
            }
            heartsVisual.textContent = hearts;

            let progress = '';
            for (let i = 1; i <= 10; i++) {
                progress += i <= previewRatingValue ? '‚ñ∞' : '‚ñ±';
            }
            progressVisual.textContent = progress;
        }

        function generateRatingVisual(style, rating) {
            let visual = '';
            switch(style) {
                case 'hearts':
                    for (let i = 1; i <= 10; i++) {
                        visual += i <= rating ? '‚ù§Ô∏è' : 'ü§ç';
                    }
                    break;
                case 'progress':
                    for (let i = 1; i <= 10; i++) {
                        visual += i <= rating ? '‚ñ∞' : '‚ñ±';
                    }
                    break;
                default:
                    for (let i = 1; i <= 10; i++) {
                        visual += i <= rating ? '‚òÖ' : '‚òÜ';
                    }
                    break;
            }
            return visual;
        }

        function updateAddonNamePreview() {
            const showUsername = showUsernameCheckbox.checked;
            if (showUsername && currentUsername) {
                addonNamePreview.textContent = `Trakt Sync & Rate (${currentUsername})`;
            } else {
                addonNamePreview.textContent = `Trakt Sync & Rate`;
            }
        }

        function generateRatingPresets() {
            ratingPresetsDiv.innerHTML = '';
            for (let rating = 1; rating <= 10; rating++) {
                const isSelected = selectedRatings.includes(rating);
                let stars = '';
                for (let i = 1; i <= 10; i++) {
                    stars += i <= rating ? '‚òÖ' : '‚òÜ';
                }
                const preset = document.createElement('div');
                preset.className = `rating-preset ${isSelected ? 'selected' : ''}`;
                preset.innerHTML = `
                    <div class="stars">${stars}</div>
                    <div class="value">${rating}/10</div>
                `;
                preset.onclick = () => toggleRatingPreset(rating);
                ratingPresetsDiv.appendChild(preset);
            }
        }

        function toggleRatingPreset(rating) {
            const index = selectedRatings.indexOf(rating);
            if (index > -1) {
                selectedRatings.splice(index, 1);
            } else {
                selectedRatings.push(rating);
                selectedRatings.sort((a, b) => a - b);
            }
            generateRatingPresets();
            updateSelectedCount();
            updatePreview();
            saveData();
        }

        function selectAllRatings() {
            selectedRatings = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            generateRatingPresets();
            updateSelectedCount();
            updatePreview();
            saveData();
        }

        function clearAllRatings() {
            selectedRatings = [];
            generateRatingPresets();
            updateSelectedCount();
            updatePreview();
            saveData();
        }

        function selectDefaultRatings() {
            selectedRatings = [5, 7, 10];
            generateRatingPresets();
            updateSelectedCount();
            updatePreview();
            saveData();
        }

        function updateSelectedCount() {
            selectedCountSpan.textContent = `${selectedRatings.length}/10`;
        }

        function updatePreview() {
            const enableWatched = enableWatchedCheckbox.checked;
            const enableUnwatched = enableUnwatchedCheckbox.checked;
            const enableSeasonWatched = enableSeasonWatchedCheckbox.checked;
            const enableRatings = enableRatingsCheckbox.checked;
            const enableWatchlist = enableWatchlistCheckbox.checked;
            const enableRemoveFromWatchlist = enableRemoveFromWatchlistCheckbox.checked;

            // Movie preview
            let movieWatchedHTML = '';
            let movieUnwatchedHTML = '';
            let movieWatchlistHTML = '';
            let movieRatingsHTML = '';
            let movieStreams = 0;

            if (enableWatched) {
                movieWatchedHTML = '<div class="preview-item watched">‚úÖ Mark "The Matrix" as Watched</div>';
                movieStreams += 1;
            }

            if (enableUnwatched) {
                movieUnwatchedHTML = '<div class="preview-item unwatched">‚ùå Mark "The Matrix" as Unwatched</div>';
                movieStreams += 1;
            }

            if (enableWatchlist) {
                movieWatchlistHTML = '<div class="preview-item watchlist">üì• Add to Watchlist<br>üé¨ "The Matrix" (1999)<br>‚úÖ Add movie to your Trakt watchlist</div>';
                movieStreams += 1;
            }

            if (enableRemoveFromWatchlist) {
                movieWatchlistHTML += '<div class="preview-item watchlist-remove">üì§ Remove from Watchlist<br>üé¨ "The Matrix" (1999)<br>üóëÔ∏è Remove movie from your Trakt watchlist</div>';
                movieStreams += 1;
            }

            if (enableRatings && selectedRatings.length > 0) {
                selectedRatings.forEach(rating => {
                    movieRatingsHTML += `<div class="preview-item rating">${formatRatingPreview(rating, 'movie', 'The Matrix', '1999')}</div>`;
                    movieStreams += 1;
                });
            }

            movieWatchedContent.innerHTML = movieWatchedHTML || '<div class="preview-item" style="color:#888;">No watched options enabled</div>';
            movieUnwatchedContent.innerHTML = movieUnwatchedHTML || '<div class="preview-item" style="color:#888;">No unwatched options enabled</div>';
            movieWatchlistContent.innerHTML = movieWatchlistHTML || '<div class="preview-item" style="color:#888;">No watchlist options enabled</div>';
            movieRatingsContent.innerHTML = movieRatingsHTML || '<div class="preview-item" style="color:#888;">No rating options enabled</div>';
            movieStreamCount.textContent = movieStreams;

            // Series preview (episode view)
            let seriesWatchedHTML = '';
            let seriesWatchlistHTML = '';
            let seriesRatingsHTML = '';
            let seriesStreams = 0;

            if (enableWatched) {
                seriesWatchedHTML = `<div class="preview-item watched">‚úÖ Mark S1E1 of "Breaking Bad" as Watched</div>`;
                seriesStreams += 1;

                if (enableSeasonWatched) {
                    seriesWatchedHTML += `<div class="preview-item season">üìÖ Mark Season 1 of "Breaking Bad" as Watched</div>`;
                    seriesStreams += 1;
                }

                seriesWatchedHTML += `<div class="preview-item watched">üì∫ Mark Entire "Breaking Bad" Series as Watched</div>`;
                seriesStreams += 1;
            }

            if (enableUnwatched) {
                seriesWatchedHTML += `<div class="preview-item unwatched">‚ùå Mark S1E1 of "Breaking Bad" as Unwatched</div>`;
                seriesStreams += 1;
            }

            if (enableWatchlist) {
                seriesWatchlistHTML = '<div class="preview-item watchlist">üì• Add to Watchlist<br>üì∫ "Breaking Bad" (Series)<br>‚úÖ Add series to your Trakt watchlist</div>';
                seriesStreams += 1;
            }

            if (enableRemoveFromWatchlist) {
                seriesWatchlistHTML += '<div class="preview-item watchlist-remove">üì§ Remove from Watchlist<br>üì∫ "Breaking Bad" (Series)<br>üóëÔ∏è Remove series from your Trakt watchlist</div>';
                seriesStreams += 1;
            }

            if (enableRatings && selectedRatings.length > 0) {
                selectedRatings.forEach(rating => {
                    seriesRatingsHTML += `<div class="preview-item rating">${formatRatingPreview(rating, 'series', 'Breaking Bad', null, 1, 1)}</div>`;
                    seriesStreams += 1;
                });
            }

            seriesWatchedContent.innerHTML = seriesWatchedHTML || '<div class="preview-item" style="color:#888;">No watched options enabled</div>';
            seriesWatchlistContent.innerHTML = seriesWatchlistHTML || '<div class="preview-item" style="color:#888;">No watchlist options enabled</div>';
            seriesRatingsContent.innerHTML = seriesRatingsHTML || '<div class="preview-item" style="color:#888;">No rating options enabled</div>';
            seriesStreamCount.textContent = seriesStreams;
        }

        function formatRatingPreview(rating, type, title, year, season = null, episode = null) {
            const visual = generateRatingVisual(selectedRatingStyle, rating);
            const statsLine = getStatsLinePreview(rating);
            
            switch(selectedRatingPattern) {
                case 0:
                    if (type === 'movie') {
                        return `${visual}<br>"${title}" ${rating}/10`;
                    } else if (season && episode) {
                        return `${visual}<br>S${season}E${episode} "${title}" ${rating}/10`;
                    } else {
                        return `${visual}<br>"${title}" Series ${rating}/10`;
                    }
                case 1:
                    if (type === 'movie') {
                        return `‚≠ê Rating: ${rating}/10<br>üé¨ ${title}${year ? ` (${year})` : ' (Movie)'}<br>${visual}<br>${statsLine}<br>üìä ${rating} out of 10 stars`;
                    } else if (season && episode) {
                        return `‚≠ê Rating: ${rating}/10<br>üì∫ ${title} S${season}E${episode}<br>${visual}<br>${statsLine}<br>üìä ${rating} out of 10 stars`;
                    } else {
                        return `‚≠ê Rating: ${rating}/10<br>üì∫ ${title} (Series)<br>${visual}<br>${statsLine}<br>üìä ${rating} out of 10 stars`;
                    }
                case 6:
                    if (type === 'movie') {
                        return `üé¨ ${title}${year ? ` (${year})` : ''}<br>‚≠ê ${visual}<br>üéØ Rating ${rating}/10<br>${statsLine}<br>üìä ${rating} out of 10 stars`;
                    } else if (season && episode) {
                        return `üì∫ ${title} S${season}E${episode}<br>‚≠ê ${visual}<br>üéØ Rating ${rating}/10<br>${statsLine}<br>üìä ${rating} out of 10 stars`;
                    } else {
                        return `üì∫ ${title} (Series)<br>‚≠ê ${visual}<br>üéØ Rating ${rating}/10<br>${statsLine}<br>üìä ${rating} out of 10 stars`;
                    }
                default:
                    return `${visual}<br>"${title}" ${rating}/10`;
            }
        }

        function startAuth() {
            const clientId = clientIdInput.value.trim();
            if (!clientId) {
                alert('Please enter your Trakt Client ID');
                return;
            }
            saveData();
            authPopup.style.display = 'flex';
        }

        function openTraktAuth() {
            const clientId = clientIdInput.value.trim();
            if (!clientId) return;
            const authUrl = `${window.location.origin}/oauth/initiate?clientId=${encodeURIComponent(clientId)}`;
            window.open(authUrl, '_blank', 'width=600,height=700');
        }

        function closeAuthPopup() {
            authPopup.style.display = 'none';
            authCodeInput.value = '';
        }

        async function submitAuthCode() {
            const clientId = clientIdInput.value.trim();
            const authCode = authCodeInput.value.trim();

            if (!clientId || !authCode) {
                alert('Please enter both Client ID and Authorization Code');
                return;
            }

            try {
                popupAuthStatus.className = 'status';
                popupAuthStatus.textContent = 'Authenticating...';

                const response = await fetch('/oauth/exchange', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: authCode, clientId: clientId })
                });

                const data = await response.json();

                if (data.success) {
                    traktTokens = data.tokens;
                    currentUsername = data.username;
                    
                    // Update both status displays
                    mainAuthStatus.className = 'status status-success';
                    mainAuthStatus.innerHTML = `Connected as: <strong>${data.username}</strong>`;
                    
                    popupAuthStatus.className = 'status status-success';
                    popupAuthStatus.innerHTML = `Connected as: <strong>${data.username}</strong>`;

                    closeAuthPopup();
                    updateAddonNamePreview();
                    generateAddonUrl();
                } else {
                    popupAuthStatus.className = 'status status-error';
                    popupAuthStatus.textContent = `Error: ${data.error}`;
                    throw new Error(data.error);
                }
            } catch (error) {
                popupAuthStatus.className = 'status status-error';
                popupAuthStatus.textContent = `Authorization failed: ${error.message}`;
                console.error('Auth error:', error);
            }
        }

        function generateAddonUrl() {
            if (!traktTokens) {
                alert('Please connect to Trakt first');
                return;
            }

            const config = {
                clientId: clientIdInput.value.trim(),
                access_token: traktTokens.access_token,
                refresh_token: traktTokens.refresh_token,
                expires_in: traktTokens.expires_in,
                expires_at: traktTokens.expires_at,
                created_at: traktTokens.created_at,
                username: traktTokens.username,
                tmdbKey: tmdbKeyInput.value.trim() || undefined,
                ratings: enableRatingsCheckbox.checked ? selectedRatings : [],
                markAsWatched: enableWatchedCheckbox.checked,
                markAsUnwatched: enableUnwatchedCheckbox.checked,
                enableSeasonWatched: enableSeasonWatchedCheckbox.checked,
                enableWatchlist: enableWatchlistCheckbox.checked,
                enableRemoveFromWatchlist: enableRemoveFromWatchlistCheckbox.checked,
                showUsernameInName: showUsernameCheckbox.checked,
                ratingStyle: selectedRatingStyle,
                ratingPattern: selectedRatingPattern,
                statsFormat: selectedStatsFormat,
                selectedStats: selectedStats,
                markAsPlayedOnRate: markAsPlayedOnRateCheckbox.checked
            };

            Object.keys(config).forEach(key => config[key] === undefined && delete config[key]);

            const configJson = JSON.stringify(config);
            const configBase64 = btoa(configJson)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/g, '');

            const addonUrl = `${window.location.origin}/configured/${configBase64}/manifest.json`;
            addonUrlDiv.textContent = addonUrl;
            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
            saveData();
        }

        function installInStremioDesktop() {
            const addonUrl = addonUrlDiv.textContent;
            if (addonUrl) {
                const stremioUrl = 'stremio://' + addonUrl.replace(/^https?:\/\//, '');
                window.location.href = stremioUrl;
            }
        }

        function installInStremioWeb() {
            const addonUrl = addonUrlDiv.textContent;
            if (addonUrl) {
                const installUrl = `https://web.stremio.com/#/addons?addon=${encodeURIComponent(addonUrl)}`;
                window.open(installUrl, '_blank');
            }
        }

        function copyToClipboard() {
            const addonUrl = addonUrlDiv.textContent;
            if (addonUrl) {
                navigator.clipboard.writeText(addonUrl).then(() => {
                    alert('Addon URL copied to clipboard!');
                }).catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = addonUrl;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('Addon URL copied to clipboard!');
                });
            }
        }

        async function testAddon() {
            const addonUrl = addonUrlDiv.textContent;
            if (!addonUrl) return;

            try {
                const response = await fetch(addonUrl);
                if (response.ok) {
                    const manifest = await response.json();
                    alert(`‚úÖ Addon works!\n\nName: ${manifest.name}\nDescription: ${manifest.description}\nID: ${manifest.id}`);
                } else {
                    alert(`‚ùå Failed to fetch manifest: ${response.status}\n\nMake sure the addon server is running and accessible.`);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function resetConfig() {
            if (confirm('Are you sure you want to reset all configuration? This will clear your settings and disconnect from Trakt.')) {
                localStorage.removeItem('trakt_config');
                clientIdInput.value = '';
                tmdbKeyInput.value = '';
                showUsernameCheckbox.checked = true;
                enableWatchedCheckbox.checked = true;
                enableUnwatchedCheckbox.checked = true;
                enableSeasonWatchedCheckbox.checked = true;
                enableWatchlistCheckbox.checked = true;
                enableRemoveFromWatchlistCheckbox.checked = true;
                enableRatingsCheckbox.checked = true;
                markAsPlayedOnRateCheckbox.checked = false;
                selectedRatings = [5, 7, 10];
                selectedRatingStyle = 'stars';
                selectedRatingPattern = 0;
                selectedStatsFormat = 1;
                selectedStats = ['plays', 'comments', 'watchers'];
                previewRatingValue = 5;
                ratingSlider.value = '5';
                sliderValue.textContent = '5';
                traktTokens = null;
                currentUsername = 'TraktUser';
                mainAuthStatus.className = 'status status-warning';
                mainAuthStatus.textContent = 'Not connected to Trakt';
                resultSection.style.display = 'none';

                stat1Select.value = 'plays';
                stat2Select.value = 'comments';
                stat3Select.value = 'watchers';

                // Update style selection visually
                document.querySelectorAll('.rating-style-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                document.getElementById('style-stars').classList.add('selected');

                document.querySelectorAll('.pattern-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.querySelector('input[type="radio"]').checked = false;
                });
                document.getElementById('pattern-option-0').classList.add('selected');
                document.getElementById('pattern0').checked = true;

                document.querySelectorAll('.stats-format-option').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.querySelector('input[type="radio"]').checked = false;
                });
                document.getElementById('stats-option-1').classList.add('selected');
                document.getElementById('stats1').checked = true;

                generateRatingPresets();
                updateSelectedCount();
                updateRatingStyleVisuals();
                updatePatternPreview();
                updateSelectedStatsDisplay();
                updateAddonNamePreview();
                updatePreview();

                alert('Configuration reset successfully!');
            }
        }

        function loadSavedData() {
            const saved = localStorage.getItem('trakt_config');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.clientId) clientIdInput.value = data.clientId;
                    if (data.tmdbKey) tmdbKeyInput.value = data.tmdbKey;
                    if (data.ratings) selectedRatings = data.ratings;
                    if (data.showUsernameInName !== undefined) showUsernameCheckbox.checked = data.showUsernameInName;
                    if (data.enableWatched !== undefined) enableWatchedCheckbox.checked = data.enableWatched;
                    if (data.enableUnwatched !== undefined) enableUnwatchedCheckbox.checked = data.enableUnwatched;
                    if (data.enableSeasonWatched !== undefined) enableSeasonWatchedCheckbox.checked = data.enableSeasonWatched;
                    if (data.enableWatchlist !== undefined) {
                        enableWatchlist = data.enableWatchlist;
                        enableWatchlistCheckbox.checked = enableWatchlist;
                    }
                    if (data.enableRemoveFromWatchlist !== undefined) {
                        enableRemoveFromWatchlist = data.enableRemoveFromWatchlist;
                        enableRemoveFromWatchlistCheckbox.checked = enableRemoveFromWatchlist;
                    }
                    if (data.enableRatings !== undefined) enableRatingsCheckbox.checked = data.enableRatings;
                    if (data.markAsPlayedOnRate !== undefined) markAsPlayedOnRateCheckbox.checked = data.markAsPlayedOnRate;
                    if (data.ratingStyle) selectedRatingStyle = data.ratingStyle;
                    if (data.ratingPattern !== undefined) selectedRatingPattern = data.ratingPattern;
                    if (data.statsFormat !== undefined) selectedStatsFormat = data.statsFormat;
                    if (data.selectedStats) selectedStats = data.selectedStats;
                    if (data.previewRatingValue) {
                        previewRatingValue = data.previewRatingValue;
                        ratingSlider.value = previewRatingValue;
                        sliderValue.textContent = previewRatingValue;
                    }

                    // Update style selection visually
                    document.querySelectorAll('.rating-style-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    document.getElementById(`style-${selectedRatingStyle}`).classList.add('selected');

                    document.querySelectorAll('.pattern-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input[type="radio"]').checked = false;
                    });
                    const patternOption = document.getElementById(`pattern-option-${selectedRatingPattern}`);
                    if (patternOption) {
                        patternOption.classList.add('selected');
                        patternOption.querySelector('input[type="radio"]').checked = true;
                    }

                    document.querySelectorAll('.stats-format-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('input[type="radio"]').checked = false;
                    });
                    const statsOption = document.getElementById(`stats-option-${selectedStatsFormat}`);
                    if (statsOption) {
                        statsOption.classList.add('selected');
                        statsOption.querySelector('input[type="radio"]').checked = true;
                    }

                    if (selectedStats.length >= 3) {
                        stat1Select.value = selectedStats[0];
                        stat2Select.value = selectedStats[1];
                        stat3Select.value = selectedStats[2];
                    }

                    generateRatingPresets();
                    updateSelectedCount();
                    updateRatingStyleVisuals();
                    updatePatternPreview();
                    updateSelectedStatsDisplay();
                    updateAddonNamePreview();
                    ratingSection.style.display = enableRatingsCheckbox.checked ? 'block' : 'none';
                } catch (e) {
                    console.warn('Failed to load saved data:', e);
                }
            }
        }

        function saveData() {
            const data = {
                clientId: clientIdInput.value.trim(),
                tmdbKey: tmdbKeyInput.value.trim(),
                ratings: selectedRatings,
                showUsernameInName: showUsernameCheckbox.checked,
                enableWatched: enableWatchedCheckbox.checked,
                enableUnwatched: enableUnwatchedCheckbox.checked,
                enableSeasonWatched: enableSeasonWatchedCheckbox.checked,
                enableWatchlist: enableWatchlistCheckbox.checked,
                enableRemoveFromWatchlist: enableRemoveFromWatchlistCheckbox.checked,
                enableRatings: enableRatingsCheckbox.checked,
                markAsPlayedOnRate: markAsPlayedOnRateCheckbox.checked,
                ratingStyle: selectedRatingStyle,
                ratingPattern: selectedRatingPattern,
                statsFormat: selectedStatsFormat,
                selectedStats: selectedStats,
                previewRatingValue: previewRatingValue
            };
            localStorage.setItem('trakt_config', JSON.stringify(data));
        }
    </script>
</body>
</html>
